# CardtoImagePlugin 功能需求文档

## 模块定位

CardtoImagePlugin 是薯片生态文件转换系统的插件之一，负责将卡片文件转换为图片格式。插件依赖 CardtoHTMLPlugin 先将卡片转换为 HTML，然后使用浏览器渲染引擎将 HTML 渲染为图片。

## 核心功能

### HTML 生成

插件首先调用 CardtoHTMLPlugin 将卡片转换为 HTML。这一步复用 CardtoHTMLPlugin 的所有能力，包括卡片解析、渲染代码获取、主题应用等。HTML 生成后保存在内存中，不写入文件系统。

### 图片渲染

使用 Puppeteer 或 Playwright 启动无头浏览器，加载生成的 HTML 页面。等待页面渲染完成后，截取页面内容为图片。截图时考虑页面的实际尺寸，确保内容完整。

对于包含多个基础卡片的复合卡片，渲染主入口页面 index.html，让所有基础卡片通过 iframe 嵌套显示，最终截取完整页面。

### 输出格式

支持 PNG 和 JPG 两种输出格式。PNG 格式保持透明背景（如果有），适合需要后续合成的场景。JPG 格式文件较小，适合分享和展示。

JPG 格式支持质量参数，范围 0-100，默认 90。质量越高文件越大，图片越清晰。PNG 格式不受质量参数影响。

### 分辨率控制

支持设置输出图片的分辨率。可以指定固定的宽度和高度，也可以指定缩放比例。默认使用卡片的原始尺寸，缩放比例为 1.0。

高分辨率输出时，先放大页面视口，再截图，确保图片清晰度。支持 2x、3x 等高清输出，适合打印或高分屏显示。

## 配置选项

格式选项指定输出格式，可选 png 或 jpg，默认 png。质量选项指定 JPG 质量，范围 0-100，默认 90。缩放选项指定缩放比例，默认 1.0。宽度和高度选项指定固定尺寸，不指定则使用自适应尺寸。

背景选项指定背景颜色，默认白色。对于 PNG 格式，可以设置透明背景。等待选项指定等待时间或等待条件，确保动态内容加载完成。

## 错误处理

浏览器启动失败时返回明确的错误信息，提示检查 Puppeteer 或 Playwright 安装。页面加载超时时返回超时错误。截图失败时返回截图错误，包含具体原因。

CardtoHTMLPlugin 转换失败时，直接返回其错误信息，不进行图片渲染步骤。

## 依赖关系

插件依赖 CardtoHTMLPlugin 进行 HTML 转换。依赖 Puppeteer 或 Playwright 进行浏览器渲染。通过薯片 SDK 访问其他生态服务。
