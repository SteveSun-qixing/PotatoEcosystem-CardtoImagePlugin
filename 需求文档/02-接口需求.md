# 卡片转图片插件接口需求

**版本**: 1.0.0  
**日期**: 2026-02-03  
**状态**: 正式版

---

## 接口体系概述

CardtoImagePlugin 作为文件转换系统的插件，需要实现转换插件的标准接口规范。插件通过薯片内核注册自己，声明支持的转换能力，响应来自文件转换接口模块的转换请求。所有通信都遵循中心路由架构原则，插件不直接与其他模块通信。

接口设计分为三个层面：与转换系统的接口定义插件如何注册和响应转换请求；与渲染引擎的接口定义插件如何调用渲染能力；配置接口定义转换参数的结构和约束。

---

## 插件注册接口

插件启动时需要向文件转换接口模块注册，声明自己的转换能力。注册信息包含插件的基本元数据和支持的转换类型。

元数据部分包括插件的唯一标识符，采用「发行商:插件名」的格式，如「chipshub:card-to-image」。还包括插件的显示名称、版本号、描述信息、图标路径等。这些信息用于在应用市场和设置界面展示插件。

转换能力声明指明插件支持的源文件类型和目标文件类型。本插件的源类型是 card，目标类型是 image。进一步的细节通过转换选项指定，如具体的图片格式 PNG 或 JPG。

注册时还需要声明插件支持的配置参数及其约束。这些信息让转换接口模块可以在调用插件之前验证参数的有效性，避免无效请求到达插件。

---

## 转换请求接口

转换请求是插件最核心的接口。文件转换接口模块将转换请求路由到插件后，插件负责执行实际的转换工作。

请求参数包含源文件信息和转换选项。源文件可以通过文件路径指定，也可以直接传入卡片文件的二进制数据。如果传入路径，插件通过内核的文件服务读取文件内容；如果直接传入数据，插件解析数据获取卡片信息。

转换选项是一个结构化对象，包含所有可配置的转换参数。图片格式参数指定输出 PNG 还是 JPG。质量参数控制 JPG 的压缩程度。尺寸参数包括宽度、高度、缩放比例。导出模式参数指定导出封面还是完整内容。

输出目标可以是文件路径或内存。如果指定输出路径，插件将图片写入该路径；如果不指定，插件返回图片的二进制数据。批量转换时通常指定输出目录，单张转换时可以直接获取数据。

---

## 转换结果接口

转换完成后，插件返回转换结果。结果包含转换是否成功的状态标志，以及成功时的输出信息或失败时的错误信息。

成功结果包含输出图片的路径或数据、图片的实际尺寸、文件大小等信息。如果转换过程中有警告但不影响最终结果，警告信息也会包含在结果中。

失败结果包含错误码和错误描述。错误码使用统一的编码体系，便于程序化处理。错误描述提供人类可读的说明，帮助用户理解问题。如果失败发生在处理某个特定内容时，结果还会包含相关的上下文信息。

---

## 渲染引擎接口

插件需要调用公共基础层的卡片渲染引擎完成渲染工作。这个调用通过内核路由进行，插件不直接依赖渲染引擎模块。

渲染请求包含卡片数据、渲染目标和渲染选项。卡片数据是解析后的卡片信息，包括元数据、结构信息和内容配置。渲染目标是一个虚拟的渲染容器，具有指定的宽度和高度。渲染选项包括主题设置和渲染模式。

渲染结果是一个可以截取为图片的渲染输出。插件获取渲染结果后，调用截图接口将渲染内容转换为图片数据。截图接口支持指定截取区域、输出格式和质量参数。

---

## 配置参数接口

转换配置参数采用结构化定义，包含参数名称、类型、约束和默认值。

format 参数指定输出图片的格式，类型是字符串枚举，可选值为 png 和 jpg，默认值为 png。选择 png 时支持透明背景，选择 jpg 时可以设置压缩质量。

quality 参数控制 JPG 格式的压缩质量，类型是整数，范围从 1 到 100，默认值为 85。数值越高画质越好但文件越大。该参数仅在 format 为 jpg 时生效。

width 参数指定输出图片的宽度，类型是正整数，单位是像素。如果只指定宽度，高度按卡片原始比例计算。该参数与 scale 参数互斥。

height 参数指定输出图片的高度，类型是正整数，单位是像素。如果只指定高度，宽度按卡片原始比例计算。该参数与 scale 参数互斥。

scale 参数指定缩放比例，类型是正数，默认值为 1。设置为 2 表示输出尺寸是原始尺寸的两倍。该参数与 width、height 参数互斥。

mode 参数指定导出模式，类型是字符串枚举，可选值为 cover 和 full，默认值为 full。cover 模式只导出卡片封面，full 模式导出完整内容。

maxHeight 参数限制输出图片的最大高度，类型是正整数，单位是像素。当完整内容的高度超过此限制时，图片会被截断。该参数仅在 mode 为 full 时生效。

background 参数指定背景颜色，类型是颜色字符串，支持十六进制格式如 #FFFFFF。PNG 格式默认透明背景，JPG 格式默认白色背景。

---

## 能力查询接口

应用在使用转换功能之前，可以查询插件支持的转换能力。查询结果包含插件的元数据和详细的能力描述。

能力描述包括支持的源类型和目标类型、支持的配置参数列表、参数的约束信息。应用可以根据这些信息构建用户界面，如显示格式选择下拉框、质量滑块等。

能力查询不需要提供具体的卡片文件，是一个轻量级的元信息查询操作。查询结果可以被应用缓存，不需要每次转换前都查询。

---

## 任务管理接口

长时间运行的转换任务需要任务管理能力。应用可以启动转换任务后立即返回，通过任务 ID 查询转换进度，也可以取消正在进行的任务。

启动任务接口接收转换请求参数，返回任务 ID。后续的进度查询和取消操作都使用这个任务 ID。

进度查询接口返回任务的当前状态，包括已处理的进度、预计剩余时间、当前正在处理的内容等。对于简单的单卡片转换，进度可能只有开始和完成两个状态；对于复杂的批量转换，进度会更细粒度地反映处理情况。

取消任务接口终止正在进行的转换任务。取消操作会尽快生效，但不保证立即停止。已经完成的部分不会被回滚，取消结果会说明任务在哪个阶段被终止。

---

## 事件通知接口

插件在转换过程中会发出事件通知，应用可以订阅这些事件以获得实时反馈。

转换开始事件在任务实际开始处理时发出，包含任务 ID 和基本信息。转换进度事件在处理过程中定期发出，包含当前进度和处理详情。转换完成事件在任务结束时发出，包含最终结果或错误信息。

事件通过内核的事件系统分发。应用通过 SDK 订阅特定类型的事件，可以只订阅自己发起的任务的事件，也可以订阅所有转换任务的事件。

---

## 错误码定义

插件定义了专用的错误码体系，所有错误码以 CARD2IMG 为前缀，便于识别错误来源。

文件相关错误码从 1000 开始。CARD2IMG-1001 表示卡片文件不存在。CARD2IMG-1002 表示文件格式无效或损坏。CARD2IMG-1003 表示文件读取权限不足。

参数相关错误码从 2000 开始。CARD2IMG-2001 表示必需参数缺失。CARD2IMG-2002 表示参数类型错误。CARD2IMG-2003 表示参数值超出有效范围。CARD2IMG-2004 表示参数组合冲突。

渲染相关错误码从 3000 开始。CARD2IMG-3001 表示渲染引擎不可用。CARD2IMG-3002 表示主题包加载失败。CARD2IMG-3003 表示基础卡片渲染器缺失。CARD2IMG-3004 表示资源文件加载失败。

输出相关错误码从 4000 开始。CARD2IMG-4001 表示输出路径无效。CARD2IMG-4002 表示磁盘空间不足。CARD2IMG-4003 表示写入权限不足。

运行时错误码从 5000 开始。CARD2IMG-5001 表示转换超时。CARD2IMG-5002 表示内存不足。CARD2IMG-5003 表示任务被取消。
